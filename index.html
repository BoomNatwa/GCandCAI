<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequence Analysis Tool: GC Content & CAI Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .result-card {
            transition: all 0.3s ease-in-out;
            transform: translateY(20px);
            opacity: 0;
        }
        .result-card.visible {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-3xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8">
        
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Sequence Analysis Tool</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Calculate GC Content and Codon Adaptation Index (CAI)</p>
        </div>

        <!-- Input Section -->
        <div>
            <label for="sequence" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Enter mRNA Sequence (FASTA or raw)</label>
            <textarea id="sequence" rows="10" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Paste your sequence here... e.g., ATGTTCAGCTTTGTGGAC..."></textarea>
        </div>

        <!-- Options Section -->
        <div class="mt-6">
            <label for="organism" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Organism for CAI Calculation</label>
            <select id="organism" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <option value="human">Human (Homo sapiens)</option>
                <option value="ecoli">E. coli (Escherichia coli)</option>
                <option value="yeast">Yeast (Saccharomyces cerevisiae)</option>
            </select>
        </div>

        <!-- Action Button -->
        <div class="mt-8 text-center">
            <button id="calculateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out">
                Analyze Sequence
            </button>
        </div>

        <!-- Error Message Area -->
        <div id="error-message" class="mt-6 p-4 text-red-700 bg-red-100 dark:bg-red-900 dark:text-red-200 rounded-lg hidden"></div>

        <!-- Results Section -->
        <div id="results" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- GC Content Card -->
            <div id="gc-card" class="result-card bg-gray-50 dark:bg-gray-700 p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">GC Content</h3>
                <p id="gc-result" class="text-4xl font-bold text-indigo-500 dark:text-indigo-400 mt-2">0.00%</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Percentage of Guanine and Cytosine</p>
            </div>
            <!-- CAI Card -->
            <div id="cai-card" class="result-card bg-gray-50 dark:bg-gray-700 p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Codon Adaptation Index (CAI)</h3>
                <p id="cai-result" class="text-4xl font-bold text-teal-500 dark:text-teal-400 mt-2">0.000</p>
                <p id="cai-organism" class="text-sm text-gray-500 dark:text-gray-400 mt-1">Relative to Human</p>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // Codon to Amino Acid Mapping
        const codonToAA = {
            'TTT': 'F', 'TTC': 'F', 'TTA': 'L', 'TTG': 'L', 'CTT': 'L', 'CTC': 'L', 'CTA': 'L', 'CTG': 'L',
            'ATT': 'I', 'ATC': 'I', 'ATA': 'I', 'ATG': 'M', 'GTT': 'V', 'GTC': 'V', 'GTA': 'V', 'GTG': 'V',
            'TCT': 'S', 'TCC': 'S', 'TCA': 'S', 'TCG': 'S', 'CCT': 'P', 'CCC': 'P', 'CCA': 'P', 'CCG': 'P',
            'ACT': 'T', 'ACC': 'T', 'ACA': 'T', 'ACG': 'T', 'GCT': 'A', 'GCC': 'A', 'GCA': 'A', 'GCG': 'A',
            'TAT': 'Y', 'TAC': 'Y', 'TAA': '*', 'TAG': '*', 'CAT': 'H', 'CAC': 'H', 'CAA': 'Q', 'CAG': 'Q',
            'AAT': 'N', 'AAC': 'N', 'AAA': 'K', 'AAG': 'K', 'GAT': 'D', 'GAC': 'D', 'GAA': 'E', 'GAG': 'E',
            'TGT': 'C', 'TGC': 'C', 'TGA': '*', 'TGG': 'W', 'CGT': 'R', 'CGC': 'R', 'CGA': 'R', 'CGG': 'R',
            'AGT': 'S', 'AGC': 'S', 'AGA': 'R', 'AGG': 'R', 'GGT': 'G', 'GGC': 'G', 'GGA': 'G', 'GGG': 'G'
        };

        // Codon Usage Frequency Tables (Relative Frequencies)
        const codonUsageTables = {
            human: {'TTT': 0.46, 'TTC': 0.54, 'TTA': 0.07, 'TTG': 0.13, 'CTT': 0.13, 'CTC': 0.20, 'CTA': 0.07, 'CTG': 0.40, 'ATT': 0.36, 'ATC': 0.47, 'ATA': 0.17, 'ATG': 1.00, 'GTT': 0.18, 'GTC': 0.24, 'GTA': 0.12, 'GTG': 0.46, 'TCT': 0.18, 'TCC': 0.23, 'TCA': 0.15, 'TCG': 0.10, 'CCT': 0.18, 'CCC': 0.20, 'CCA': 0.17, 'CCG': 0.45, 'ACT': 0.14, 'ACC': 0.36, 'ACA': 0.28, 'ACG': 0.22, 'GCT': 0.18, 'GCC': 0.37, 'GCA': 0.21, 'GCG': 0.24, 'TAT': 0.44, 'TAC': 0.56, 'TAA': 0.30, 'TAG': 0.24, 'CAT': 0.43, 'CAC': 0.57, 'CAA': 0.27, 'CAG': 0.73, 'AAT': 0.47, 'AAC': 0.53, 'AAA': 0.42, 'AAG': 0.58, 'GAT': 0.46, 'GAC': 0.54, 'GAA': 0.42, 'GAG': 0.58, 'TGT': 0.46, 'TGC': 0.54, 'TGA': 0.47, 'TGG': 1.00, 'CGT': 0.08, 'CGC': 0.21, 'CGA': 0.11, 'CGG': 0.20, 'AGT': 0.15, 'AGC': 0.24, 'AGA': 0.20, 'AGG': 0.21, 'GGT': 0.16, 'GGC': 0.34, 'GGA': 0.25, 'GGG': 0.25},
            ecoli: {'TTT': 0.58, 'TTC': 0.42, 'TTA': 0.14, 'TTG': 0.13, 'CTT': 0.12, 'CTC': 0.10, 'CTA': 0.04, 'CTG': 0.47, 'ATT': 0.49, 'ATC': 0.39, 'ATA': 0.11, 'ATG': 1.00, 'GTT': 0.28, 'GTC': 0.20, 'GTA': 0.15, 'GTG': 0.37, 'TCT': 0.17, 'TCC': 0.15, 'TCA': 0.14, 'TCG': 0.14, 'CCT': 0.18, 'CCC': 0.13, 'CCA': 0.20, 'CCG': 0.36, 'ACT': 0.19, 'ACC': 0.40, 'ACA': 0.17, 'ACG': 0.25, 'GCT': 0.18, 'GCC': 0.26, 'GCA': 0.23, 'GCG': 0.33, 'TAT': 0.59, 'TAC': 0.41, 'TAA': 0.61, 'TAG': 0.09, 'CAT': 0.57, 'CAC': 0.43, 'CAA': 0.34, 'CAG': 0.66, 'AAT': 0.49, 'AAC': 0.51, 'AAA': 0.74, 'AAG': 0.26, 'GAT': 0.63, 'GAC': 0.37, 'GAA': 0.68, 'GAG': 0.32, 'TGT': 0.46, 'TGC': 0.54, 'TGA': 0.30, 'TGG': 1.00, 'CGT': 0.36, 'CGC': 0.36, 'CGA': 0.07, 'CGG': 0.11, 'AGT': 0.16, 'AGC': 0.25, 'AGA': 0.07, 'AGG': 0.04, 'GGT': 0.35, 'GGC': 0.37, 'GGA': 0.13, 'GGG': 0.15},
            yeast: {'TTT': 0.56, 'TTC': 0.44, 'TTA': 0.23, 'TTG': 0.29, 'CTT': 0.13, 'CTC': 0.06, 'CTA': 0.14, 'CTG': 0.12, 'ATT': 0.47, 'ATC': 0.26, 'ATA': 0.27, 'ATG': 1.00, 'GTT': 0.35, 'GTC': 0.20, 'GTA': 0.12, 'GTG': 0.33, 'TCT': 0.26, 'TCC': 0.17, 'TCA': 0.21, 'TCG': 0.08, 'CCT': 0.26, 'CCC': 0.10, 'CCA': 0.41, 'CCG': 0.07, 'ACT': 0.31, 'ACC': 0.25, 'ACA': 0.28, 'ACG': 0.16, 'GCT': 0.37, 'GCC': 0.24, 'GCA': 0.29, 'GCG': 0.10, 'TAT': 0.56, 'TAC': 0.44, 'TAA': 0.47, 'TAG': 0.20, 'CAT': 0.64, 'CAC': 0.36, 'CAA': 0.69, 'CAG': 0.31, 'AAT': 0.59, 'AAC': 0.41, 'AAA': 0.58, 'AAG': 0.42, 'GAT': 0.65, 'GAC': 0.35, 'GAA': 0.71, 'GAG': 0.29, 'TGT': 0.61, 'TGC': 0.39, 'TGA': 0.33, 'TGG': 1.00, 'CGT': 0.07, 'CGC': 0.04, 'CGA': 0.07, 'CGG': 0.04, 'AGT': 0.15, 'AGC': 0.12, 'AGA': 0.48, 'AGG': 0.21, 'GGT': 0.40, 'GGC': 0.23, 'GGA': 0.24, 'GGG': 0.13}
        };

        // --- DOM Elements ---
        const sequenceInput = document.getElementById('sequence');
        const calculateBtn = document.getElementById('calculateBtn');
        const organismSelect = document.getElementById('organism');
        const gcResultEl = document.getElementById('gc-result');
        const caiResultEl = document.getElementById('cai-result');
        const caiOrganismEl = document.getElementById('cai-organism');
        const errorMessageEl = document.getElementById('error-message');
        const gcCard = document.getElementById('gc-card');
        const caiCard = document.getElementById('cai-card');

        // --- Pre-computation ---
        // Pre-calculate relative adaptiveness (w) values for each organism
        const relativeAdaptiveness = {};
        for (const organism in codonUsageTables) {
            const usage = codonUsageTables[organism];
            const maxFreqPerAA = {};
            const aaToCodons = {};

            // Group codons by AA and find max frequency for each AA
            for (const codon in usage) {
                const aa = codonToAA[codon];
                if (!aa) continue;
                if (!maxFreqPerAA[aa]) {
                    maxFreqPerAA[aa] = 0;
                    aaToCodons[aa] = [];
                }
                aaToCodons[aa].push(codon);
                if (usage[codon] > maxFreqPerAA[aa]) {
                    maxFreqPerAA[aa] = usage[codon];
                }
            }
            
            // Calculate w for each codon
            relativeAdaptiveness[organism] = {};
            for (const aa in aaToCodons) {
                for (const codon of aaToCodons[aa]) {
                    if (maxFreqPerAA[aa] > 0) {
                        relativeAdaptiveness[organism][codon] = usage[codon] / maxFreqPerAA[aa];
                    } else {
                        relativeAdaptiveness[organism][codon] = 0;
                    }
                }
            }
        }

        // --- Functions ---

        /**
         * Cleans and validates the input sequence.
         * Removes FASTA headers, whitespace, and converts to uppercase.
         * @param {string} rawSeq - The raw input sequence from the textarea.
         * @returns {string|null} The cleaned sequence or null if invalid.
         */
        function cleanAndValidateSequence(rawSeq) {
            // Remove FASTA header if present
            let seq = rawSeq.startsWith('>') ? rawSeq.split('\n').slice(1).join('') : rawSeq;
            // Remove whitespace and convert to uppercase
            seq = seq.replace(/\s/g, '').toUpperCase();
            
            if (!seq) {
                showError("Sequence input is empty.");
                return null;
            }

            // Validate characters
            if (/[^ATGCU]/.test(seq)) {
                showError("Sequence contains invalid characters. Only A, T, G, C, U are allowed.");
                return null;
            }

            // Replace U with T for consistency
            return seq.replace(/U/g, 'T');
        }

        /**
         * Calculates the GC content of a DNA sequence.
         * @param {string} seq - The cleaned DNA sequence.
         * @returns {number} The GC content as a percentage.
         */
        function calculateGCContent(seq) {
            if (!seq) return 0;
            const gcCount = (seq.match(/[GC]/g) || []).length;
            return (gcCount / seq.length) * 100;
        }

        /**
         * Calculates the Codon Adaptation Index (CAI).
         * @param {string} seq - The cleaned DNA sequence.
         * @param {string} organism - The selected organism key.
         * @returns {number|null} The CAI value or null if calculation is not possible.
         */
        function calculateCAI(seq, organism) {
            const w_table = relativeAdaptiveness[organism];
            const codons = [];
            
            // Find the first start codon 'ATG'
            const startIndex = seq.indexOf('ATG');
            if (startIndex === -1) {
                showError("No start codon (ATG) found in the sequence.");
                return null;
            }

            // Extract codons from start to end, ignoring stop codons
            for (let i = startIndex; i < seq.length - 2; i += 3) {
                const codon = seq.substring(i, i + 3);
                if (codon.length !== 3) continue;
                
                const aa = codonToAA[codon];
                if (aa === '*') { // Stop codon
                    break;
                }
                // Exclude Methionine and Tryptophan as they have only one codon
                if (aa !== 'M' && aa !== 'W') {
                    codons.push(codon);
                }
            }

            if (codons.length === 0) {
                showError("No valid codons found for CAI calculation (after excluding start/stop/Met/Trp).");
                return null;
            }

            // Calculate geometric mean of relative adaptiveness values
            let logSum = 0;
            for (const codon of codons) {
                const w = w_table[codon];
                if (w > 0) { // w can be 0, which would make the product 0.
                    logSum += Math.log(w);
                } else {
                    // Handle codons with zero frequency/adaptiveness.
                    // A small value is often substituted, but for simplicity, we can log it.
                    console.warn(`Codon ${codon} has a relative adaptiveness of 0.`);
                }
            }
            
            return Math.exp(logSum / codons.length);
        }

        /**
         * Displays an error message to the user.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
            gcCard.classList.remove('visible');
            caiCard.classList.remove('visible');
        }

        /**
         * Hides the error message box.
         */
        function hideError() {
            errorMessageEl.classList.add('hidden');
        }
        
        /**
         * Main function to handle the analysis process.
         */
        function handleAnalysis() {
            hideError();
            
            const rawSequence = sequenceInput.value;
            const sequence = cleanAndValidateSequence(rawSequence);
            
            if (!sequence) {
                return; // Stop if validation failed
            }
            
            const selectedOrganism = organismSelect.value;

            // --- Calculate and Display GC Content ---
            const gcContent = calculateGCContent(sequence);
            gcResultEl.textContent = `${gcContent.toFixed(2)}%`;
            gcCard.classList.add('visible');

            // --- Calculate and Display CAI ---
            const caiValue = calculateCAI(sequence, selectedOrganism);
            if (caiValue !== null) {
                caiResultEl.textContent = caiValue.toFixed(3);
                const organismName = organismSelect.options[organismSelect.selectedIndex].text;
                caiOrganismEl.textContent = `Relative to ${organismName.split('(')[0].trim()}`;
                caiCard.classList.add('visible');
            }
        }

        // --- Event Listener ---
        calculateBtn.addEventListener('click', handleAnalysis);
        
        // --- Initial Example ---
        sequenceInput.value = `atgttcagctttgtggacctccggctcctgctcctcttagcggccaccgccctcctgacgcacggccaagaggaaggccaagtcgagggccaagacgaagacatcccaccaatcacctgcgtacagaacggcctcaggtaccatgaccgagacgtgtggaaacccgagccctgccggatctgcgtctgcgacaacggcaaggtgttgtgcgatgacgtgatctgtgacgagaccaagaactgccccggcgccgaagtccccgagggcgagtgctgtcccgtctgccccgacggctcagagtcacccaccgaccaagaaaccaccggcgtcgagggacccaagggagacactggcccccgaggcccaaggggacccgcaggcccccctggccgagatggcatccctggacagcctggacttcccggaccccccggaccccccggacctcccggaccccctggcctcggaggaaactttgctccccagctgtcttatggctatgatgagaaatcaaccggaggaatttccgtgcctggccccatgggtccctctggtcctcgtggtctccctggcccccctggtgcacctggtccccaaggcttccaaggtccccctggtgagcctggcgagcctggagcttcaggtcccatgggtccccgaggtcccccaggtccccctggaaagaatggagatgatggggaagctggaaaacctggtcgtcctggtgagcgtgggcctcctgggcctcagggtgctcgaggattgcccggaacagctggcctccctggaatgaagggacacagaggtttcaTAA`;
        handleAnalysis(); // Run analysis on the default sequence on page load

    </script>
</body>
</html>
